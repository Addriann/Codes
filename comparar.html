<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Herramienta Visual Diff</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    body {
      font-family: monospace;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    #controls {
      padding: 10px;
      text-align: center;
      transition: background 0.3s, border 0.3s;
    }
    button {
      padding: 8px 16px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    #editor {
      display: flex;
      gap: 2px;
      padding: 2px;
      height: 23vh;
    }
    .editor-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .textarea-controls {
        display: flex;
        justify-content: flex-end;
        gap: 5px;
        padding: 0 5px 2px;
    }
    .util-btn {
        padding: 2px 8px;
        font-size: 12px;
        font-family: sans-serif;
    }
    textarea {
      flex: 1;
      resize: none;
      padding: 10px;
      border: 1px solid;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      max-height: 200px;
      overflow-y: auto;
      transition: background 0.3s, color 0.3s, border 0.3s;
    }
    #result {
      flex: 1;
      display: flex;
      padding: 2px;
      overflow: hidden;
      gap: 2px;
    }
    .column {
      flex: 1;
      border: 1px solid;
      border-radius: 4px;
      padding: 10px;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: background 0.3s, border 0.3s;
    }
    .line {
      white-space: pre-wrap;
      position: relative;
      padding: 2px 25px 2px 50px;
      display: flex;
      align-items: center;
      min-height: 1.5em;
    }
    .line-number {
      position: absolute;
      left: 0;
      width: 40px;
      text-align: right;
      padding-right: 10px;
      font-size: 12px;
    }
    .line-content {
      flex: 1;
    }
    .del-btn {
      position: absolute;
      right: 2px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      border-radius: 2px;
      font-size: 10px;
      cursor: pointer;
      padding: 2px 6px;
      display: none;
    }
    .line:hover .del-btn {
      display: block;
    }

    /* Modo Oscuro (Dark Mode) */
    body.dark-mode {
      background: #121212;
      color: #fff;
    }
    .dark-mode #controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark-mode button {
      color: #000;
    }
    .dark-mode .util-btn {
      background: rgba(255, 255, 255, 0.15);
      color: #eee;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark-mode .util-btn:hover {
        background: rgba(255, 255, 255, 0.25);
    }
    .dark-mode #compareBtn {
      background: #ff00ff;
      box-shadow: 0 0 10px #ff00ff, 0 0 10px #ff00ff;
    }
    .dark-mode #compareBtn:hover {
      box-shadow: 0 0 20px #ff00ff, 0 0 20px #ff00ff;
    }
    .dark-mode #clearBtn {
      background: #00ffff;
      color: #000;
      box-shadow: 0 0 10px #00ffff, 0 0 10px #00ffff;
    }
    .dark-mode #clearBtn:hover {
      box-shadow: 0 0 20px #00ffff, 0 0 20px #00ffff;
    }
    .dark-mode #modeToggle {
      background: #ffff00;
      color: #000;
      box-shadow: 0 0 10px #ffff00, 0 0 10px #ffff00;
    }
    .dark-mode #modeToggle:hover {
      box-shadow: 0 0 20px #ffff00, 0 0 30px #ffff00;
    }
    .dark-mode textarea {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.2);
    }
    .dark-mode .column {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
    }
    .dark-mode .added { background: rgba(0, 255, 0, 0.2); }
    .dark-mode .removed { background: rgba(255, 0, 0, 0.2); }
    .dark-mode .unchanged { background: rgba(255, 255, 255, 0.05); }
    .dark-mode .placeholder { background: rgba(255, 255, 255, 0.01); }
    .dark-mode .del-btn { background: #bbb; color: #000; }
    .dark-mode .del-btn:hover { background: #999; }
    .dark-mode .line-number { color: #888; }

    /* Modo Claro (Light Mode) */
    body.light-mode {
      background: #f5f5f5;
      color: #333;
    }
    .light-mode #controls {
      background: rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }
    .light-mode button {
      color: #333;
    }
    .light-mode .util-btn {
        background: rgba(0, 0, 0, 0.08);
        color: #333;
        border: 1px solid rgba(0, 0, 0, 0.15);
    }
    .light-mode .util-btn:hover {
        background: rgba(0, 0, 0, 0.12);
    }
    .light-mode #compareBtn { background: #00ff0050; color: #fff; box-shadow: none; }
    .light-mode #compareBtn:hover { background: #00ff0080; }
    .light-mode #clearBtn { background: #aa000050; color: #fff; box-shadow: none; }
    .light-mode #clearBtn:hover { background: #aa000080; }
    .light-mode #modeToggle { background: #0000ff70; color: #fff; box-shadow: none; }
    .light-mode #modeToggle:hover { background: #0000ff90; }
    .light-mode textarea {
      background: rgba(0, 0, 0, 0.02);
      color: #111;
      border-color: rgba(0, 0, 0, 0.05);
    }
    .light-mode .column {
      background: rgba(0, 0, 0, 0.02);
      border-color: rgba(0, 0, 0, 0.05);
    }
    .light-mode .added { background: rgba(0, 255, 0, 0.2); }
    .light-mode .removed { background: rgba(255, 0, 0, 0.2); }
    .light-mode .unchanged { background: rgba(0, 0, 0, 0.03); }
    .light-mode .placeholder { background: rgba(0, 0, 0, 0.02); }
    .light-mode .del-btn { background: #444; color: #fff; }
    .light-mode .del-btn:hover { background: #666; }
    .light-mode .line-number { color: #777; }
  </style>
</head>
<body class="light-mode">
  <div id="controls">
    <button id="compareBtn">Comparar</button>
    <button id="clearBtn">Limpiar</button>
    <button id="modeToggle">Modo Oscuro</button>
  </div>
  <div id="editor">
    <div class="editor-wrapper">
        <div class="textarea-controls">
            <button id="left-unindent" class="util-btn" title="Eliminar toda la sangría">↤</button>
            <button id="left-trim-indent" class="util-btn" title="Eliminar sangría común">⇤</button>
            <button id="left-togglecase" class="util-btn" title="Convertir mayúsculas/minúsculas">Aa</button>
        </div>
        <textarea id="left" placeholder="Pega el texto original aquí..."></textarea>
    </div>
    <div class="editor-wrapper">
        <div class="textarea-controls">
             <button id="right-unindent" class="util-btn" title="Eliminar toda la sangría">↤</button>
             <button id="right-trim-indent" class="util-btn" title="Eliminar sangría común">⇤</button>
             <button id="right-togglecase" class="util-btn" title="Convertir mayúsculas/minúsculas">Aa</button>
        </div>
        <textarea id="right" placeholder="Pega el texto modificado aquí..."></textarea>
    </div>
  </div>
  <div id="result">
    <div class="column" id="leftResult"></div>
    <div class="column" id="rightResult"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
  <script>
    const leftArea = document.getElementById('left');
    const rightArea = document.getElementById('right');
    const leftRes = document.getElementById('leftResult');
    const rightRes = document.getElementById('rightResult');
    const compareBtn = document.getElementById('compareBtn');
    const clearBtn = document.getElementById('clearBtn');
    const modeToggle = document.getElementById('modeToggle');

    // Botones de herramientas
    const leftUnindentBtn = document.getElementById('left-unindent');
    const leftTrimIndentBtn = document.getElementById('left-trim-indent');
    const leftToggleCaseBtn = document.getElementById('left-togglecase');
    const rightUnindentBtn = document.getElementById('right-unindent');
    const rightTrimIndentBtn = document.getElementById('right-trim-indent');
    const rightToggleCaseBtn = document.getElementById('right-togglecase');

    // Función para alternar entre modos
    function toggleMode() {
      const currentMode = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
      const newMode = currentMode === 'dark' ? 'light' : 'dark';
      document.body.classList.remove(`${currentMode}-mode`);
      document.body.classList.add(`${newMode}-mode`);
      modeToggle.textContent = newMode === 'dark' ? 'Cambiar a Modo Claro' : 'Cambiar a Modo Oscuro';
      localStorage.setItem('mode', newMode);
    }

    // Cargar modo guardado o predeterminado
    const savedMode = localStorage.getItem('mode') || 'light';
    document.body.className = `${savedMode}-mode`;
    modeToggle.textContent = savedMode === 'dark' ? 'Cambiar a Modo Claro' : 'Cambiar a Modo Oscuro';

    // ---- Funciones de herramientas ----
    function unindentText(textArea) {
        const lines = textArea.value.split('\n');
        // MODIFICADO: Añadido \u00A0 para reconocer espacios de no separación
        const unindentedLines = lines.map(line => line.replace(/^[ \t\u00A0]+/, ''));
        textArea.value = unindentedLines.join('\n');
    }

    function trimCommonIndentation(textArea) {
        const text = textArea.value;
        const lines = text.split('\n');
        
        if (lines.length === 0) return;

        let minIndent = Infinity;
        for (const line of lines) {
            if (line.trim() === '') continue;
            
            // MODIFICADO: Añadido \u00A0 para reconocer espacios de no separación
            const leadingWhitespace = line.match(/^[ \t\u00A0]*/)[0];
            if (leadingWhitespace.length < minIndent) {
                minIndent = leadingWhitespace.length;
            }
        }

        if (minIndent > 0 && minIndent !== Infinity) {
            const newLines = lines.map(line => {
                return line.trim() === '' ? line : line.substring(minIndent);
            });
            textArea.value = newLines.join('\n');
        }
    }

    function toggleCaseText(textArea) {
        const text = textArea.value;
        const isMostlyLowercase = (text.match(/[a-z]/g) || []).length >= (text.match(/[A-Z]/g) || []).length;
        textArea.value = isMostlyLowercase ? text.toUpperCase() : text.toLowerCase();
    }
    
    // ---- Lógica de comparación (Diff) ----
    function createLine(content, className, lineNumber) {
      const div = document.createElement('div');
      div.className = `line ${className}`;
      if (lineNumber !== null) {
        const numSpan = document.createElement('span');
        numSpan.className = 'line-number';
        numSpan.textContent = lineNumber;
        div.appendChild(numSpan);
      }
      const textSpan = document.createElement('span');
      textSpan.className = 'line-content';
      textSpan.textContent = content;
      div.appendChild(textSpan);
      return div;
    }

    function renderDiff() {
      leftRes.innerHTML = '';
      rightRes.innerHTML = '';
      const oldText = leftArea.value;
      const newText = rightArea.value;
      const diff = Diff.diffLines(oldText, newText, { newlineIsToken: true });

      let leftLine = 1;
      let rightLine = 1;
      let i = 0;

      while (i < diff.length) {
        const part = diff[i];
        const nextPart = diff[i + 1] || { value: '', added: false, removed: false };
        const lines = part.value.split(/\n/).filter(line => line !== '');

        if ((part.added && nextPart.removed) || (part.removed && nextPart.added)) {
          const removedLines = (part.removed ? part.value : nextPart.value).split(/\n/).filter(l => l !== '');
          const addedLines = (part.added ? part.value : nextPart.value).split(/\n/).filter(l => l !== '');
          const maxLen = Math.max(addedLines.length, removedLines.length);

          for (let j = 0; j < maxLen; j++) {
            const leftContent = j < removedLines.length ? removedLines[j] : '';
            const rightContent = j < addedLines.length ? addedLines[j] : '';
            const spanLeft = createLine(leftContent, leftContent ? 'removed' : 'placeholder', leftContent ? leftLine++ : null);
            const spanRight = createLine(rightContent, rightContent ? 'added' : 'placeholder', rightContent ? rightLine++ : null);
            
            if (leftContent) addDeleteButton(spanLeft, leftArea, leftContent, 'original');
            if (rightContent) addDeleteButton(spanRight, rightArea, rightContent, 'modificado');
            
            leftRes.appendChild(spanLeft);
            rightRes.appendChild(spanRight);
          }
          i += 2;
        } else if (part.added) {
          lines.forEach(line => {
            const spanRight = createLine(line, 'added', rightLine++);
            addDeleteButton(spanRight, rightArea, line, 'modificado');
            leftRes.appendChild(createLine('', 'placeholder', null));
            rightRes.appendChild(spanRight);
          });
          i++;
        } else if (part.removed) {
          lines.forEach(line => {
            const spanLeft = createLine(line, 'removed', leftLine++);
            addDeleteButton(spanLeft, leftArea, line, 'original');
            leftRes.appendChild(spanLeft);
            rightRes.appendChild(createLine('', 'placeholder', null));
          });
          i++;
        } else {
          lines.forEach(line => {
            leftRes.appendChild(createLine(line, 'unchanged', leftLine++));
            rightRes.appendChild(createLine(line, 'unchanged', rightLine++));
          });
          i++;
        }
      }
    }
    
    function addDeleteButton(span, textArea, lineText, origin) {
        const btn = document.createElement('button');
        btn.textContent = '×';
        btn.className = 'del-btn';
        btn.title = `Eliminar del ${origin}`;
        btn.onclick = () => {
            if (confirm(`¿Eliminar esta línea del texto ${origin}?`)) {
                removeLine(textArea, lineText);
            }
        };
        span.appendChild(btn);
    }

    function removeLine(textArea, lineText) {
      const lines = textArea.value.split(/\n/);
      const idx = lines.findIndex(l => l === lineText);
      if (idx > -1) {
        lines.splice(idx, 1);
        textArea.value = lines.join('\n');
        renderDiff();
      }
    }
    
    // --- Event Listeners ---
    compareBtn.addEventListener('click', renderDiff);
    clearBtn.addEventListener('click', () => {
      leftArea.value = '';
      rightArea.value = '';
      leftRes.innerHTML = '';
      rightRes.innerHTML = '';
    });
    modeToggle.addEventListener('click', toggleMode);

    // Listeners para botones de herramientas
    leftUnindentBtn.addEventListener('click', () => unindentText(leftArea));
    leftTrimIndentBtn.addEventListener('click', () => trimCommonIndentation(leftArea));
    leftToggleCaseBtn.addEventListener('click', () => toggleCaseText(leftArea));
    
    rightUnindentBtn.addEventListener('click', () => unindentText(rightArea));
    rightTrimIndentBtn.addEventListener('click', () => trimCommonIndentation(rightArea));
    rightToggleCaseBtn.addEventListener('click', () => toggleCaseText(rightArea));

    // Sincronizar scroll
    let isScrolling = false;
    [leftRes, rightRes].forEach((el, idx, arr) => {
        el.addEventListener('scroll', () => {
            if (!isScrolling) {
                isScrolling = true;
                arr[1 - idx].scrollTop = el.scrollTop;
                isScrolling = false;
            }
        });
    });

    // Autoajustar altura de textareas
    [leftArea, rightArea].forEach(el => {
      function autoGrow() {
        el.style.height = 'auto';
        el.style.height = `${el.scrollHeight}px`;
      }
      el.addEventListener('input', autoGrow);
      setTimeout(autoGrow, 10);
    });
  </script>
</body>
</html>
